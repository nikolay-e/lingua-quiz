# Логика Уровней Переводов в LinguaQuiz

## Обзор Системы Уровней

Система использует 4 уровня для отслеживания прогресса изучения каждого перевода:

- **LEVEL_0** - Новые слова (еще не изучались)
- **LEVEL_1** - Слова в изучении (фокусные слова, максимум 20 одновременно)
- **LEVEL_2** - Слова, освоенные в одном направлении
- **LEVEL_3** - Слова, полностью освоенные в обоих направлениях

## Константы Системы

- **MAX_FOCUS_WORDS**: 20 слов одновременно в LEVEL_1
- **CORRECT_ANSWERS_TO_MASTER**: 3 правильных ответа ПОДРЯД для перехода на следующий уровень
- **MISTAKES_IN_LAST_ATTEMPTS**: 3 ошибки из последних 10 попыток слова для деградации
- **LAST_ATTEMPTS_COUNT**: 10 попыток для анализа деградации
- **MAX_LAST_ASKED_WORDS**: 7 последних неповторяющихся слов (избежание повторов)
- **CONSECUTIVE_CORRECT_RESET**: Сброс счетчика правильных ответов при ошибке

## Движение Между Уровнями

### LEVEL_0 → LEVEL_1 (Автоматическое пополнение)

**Условие активации:**
Когда в LEVEL_1 меньше 20 слов

**Процесс:**
1. Система автоматически проверяет количество слов в LEVEL_1
2. Если меньше 20 слов, берет случайные слова из LEVEL_0
3. Переводит их в LEVEL_1 и сбрасывает все статистики
4. Происходит при каждом запросе следующего вопроса

### LEVEL_1 → LEVEL_2 (По достижению мастерства)

**ВАЖНО**: Для перехода нужно **3 правильных ответа ПОДРЯД**

**Процесс:**
1. Слово изучается в **нормальном направлении** (источник → цель)
2. Система отслеживает последовательные правильные ответы для этого слова
3. При правильном ответе счетчик правильных подряд увеличивается
4. При неправильном ответе счетчик правильных подряд сбрасывается в 0
5. При достижении 3 правильных ответов подряд → переход в LEVEL_2
6. Все статистики сбрасываются на ноль
7. Слово больше не появляется в нормальном направлении
8. Освобождается место в LEVEL_1 для нового слова из LEVEL_0

### LEVEL_2 → LEVEL_3 (Полное освоение)

**ВАЖНО**: Для перехода нужно **3 правильных ответа ПОДРЯД**

**Процесс:**
1. Слово изучается в **обратном направлении** (цель → источник)
2. Система отслеживает последовательные правильные ответы для этого слова в обратном направлении
3. При правильном ответе счетчик правильных подряд увеличивается
4. При неправильном ответе счетчик правильных подряд сбрасывается в 0
5. При достижении 3 правильных ответов подряд → переход в LEVEL_3
6. Слово считается полностью освоенным
7. Больше не появляется в вопросах

### Понижение Уровня (Деградация)

**ВАЖНО**: Для деградации нужно **3 ошибки из последних 10 попыток данного слова** (не обязательно подряд)

**Процесс деградации:**
- **LEVEL_3 → LEVEL_2**: Слово снова появляется в обратном направлении
- **LEVEL_2 → LEVEL_1**: Слово возвращается в фокусные (может потребовать места)
- **LEVEL_1 → LEVEL_0**: Слово становится неактивным (редко происходит)

**Механизм отслеживания:**
- Система отслеживает последние 10 попыток для каждого конкретного слова
- Подсчитывает количество неправильных ответов в этих 10 попытках именно для этого слова
- При достижении 3 неправильных ответов из последних 10 попыток: слово понижается на уровень
- Это позволяет учитывать общую тенденцию к ошибкам с конкретным словом, а не только подряд идущие ошибки

## Направления Изучения

### Нормальное направление (Source → Target)

**Цель:** Изучение новых слов и закрепление базового понимания

**Активные уровни:**
- **LEVEL_1** (приоритет) - фокусные слова
- **LEVEL_2** (резерв) - если нет LEVEL_1 слов

**Логика выбора:**
Приоритет отдается словам LEVEL_1, если их нет - используются слова LEVEL_2

### Обратное направление (Target → Source)

**Цель:** Достижение полного освоения слов

**Активные уровни:**
- **LEVEL_2** (приоритет) - слова для полного освоения
- **LEVEL_1** (резерв) - если нет LEVEL_2 слов

**Автоматическое переключение:**
Если нет слов LEVEL_2, автоматически переключается на нормальное направление

## Популяция Слов (Алгоритм Заполнения)

### Инициализация Новой Сессии

**Процесс запуска:**
1. Все слова начинают с LEVEL_0
2. Автоматически заполняем LEVEL_1 (20 случайных слов)
3. Устанавливаем нормальное направление

### Динамическое Пополнение

**При каждом запросе вопроса:**
1. Проверяем количество фокусных слов в LEVEL_1
2. Если меньше 20 - пополняем из LEVEL_0 до максимума
3. Выбираем следующий вопрос

### Приоритизация по Ошибкам

**Система взвешенного выбора:**
1. Исключаем недавно заданные слова (последние 7 по MAX_LAST_ASKED_WORDS)
2. Сортируем по количеству ошибок (больше ошибок = выше приоритет)
3. Применяем случайность для разнообразия

### Избежание Повторов

**Механизм неповторяющихся слов:**
- Система запоминает последние 7 заданных слов (MAX_LAST_ASKED_WORDS)
- При выборе следующего вопроса исключает эти слова из кандидатов
- Это предотвращает монотонное повторение одних и тех же слов
- Если после исключения не остается кандидатов, используются все доступные слова
- Список обновляется при каждом новом вопросе (добавляется новое, удаляется самое старое)

## Статистика и Отслеживание

### Статистика по Направлениям

Каждое слово имеет отдельную статистику для каждого направления:
- ID перевода
- Направление (нормальное/обратное)
- Общее количество попыток
- Правильные ответы (всего)
- Неправильные ответы (всего)
- Ошибки подряд (для деградации)
- Время последнего ответа

### Глобальный Прогресс

Отслеживается для каждого пользователя:
- ID пользователя
- ID перевода
- Текущий уровень (LEVEL_0, LEVEL_1, LEVEL_2, LEVEL_3)
- Время последнего обновления

## Примеры Сценариев

### Сценарий 1: Новый пользователь

1. **Начало:** Все 100 слов в LEVEL_0
2. **Пополнение:** 20 случайных слов → LEVEL_1
3. **Изучение:** Пользователь изучает эти 20 слов в нормальном направлении
4. **Прогресс:** По мере освоения, слова переходят в LEVEL_2
5. **Пополнение:** Новые слова из LEVEL_0 автоматически заполняют LEVEL_1

### Сценарий 2: Переключение направления

1. **Накопление:** В LEVEL_2 накапливается 5+ слов
2. **Переключение:** Пользователь переключается на обратное направление
3. **Освоение:** Изучает слова LEVEL_2 в обратном направлении
4. **Завершение:** Слова переходят в LEVEL_3 (полностью освоены)

### Сценарий 3: Деградация

1. **Ошибки:** Пользователь делает 3 ошибки подряд со словом в LEVEL_2
2. **Понижение:** Слово возвращается в LEVEL_1
3. **Повторное изучение:** Слово снова появляется в нормальном направлении
4. **Восстановление:** При 3 правильных ответах снова переходит в LEVEL_2

## Особенности Алгоритма

### Предотвращение Перегрузки

- **Лимит фокуса:** Максимум 20 слов в активном изучении
- **Интеллектуальная очередь:** Новые слова ждут освобождения места
- **Балансировка нагрузки:** Равномерное распределение сложности

### Адаптивность

- **Автоматическое направление:** Система переключается при необходимости
- **Приоритет сложных слов:** Слова с ошибками появляются чаще
- **Избегание повторов:** Недавние слова исключаются из выбора

### Эффективность

- **Прогрессивное освоение:** От простого к сложному
- **Двунаправленное закрепление:** Полное понимание в обе стороны
- **Интервальное повторение:** Основано на принципах забывчивости

Эта система обеспечивает оптимальное изучение языка через научно обоснованные принципы интервального повторения и адаптивного обучения.

---

## ТРЕБУЕМЫЕ ИЗМЕНЕНИЯ В РЕАЛИЗАЦИИ

### 1. Новая Таблица для Отслеживания Подач Ответов

**Проблема:** Текущая система не отслеживает индивидуальные подачи ответов, только агрегированную статистику.

**Решение:** Создать таблицу `quiz_submission_log`:

**Структура таблицы:**
- `id` - уникальный идентификатор записи
- `session_id` - ссылка на quiz_session
- `translation_id` - ID перевода (слова)
- `direction` - направление ('normal' или 'reverse')
- `user_answer` - ответ пользователя
- `correct_answer` - правильный ответ
- `is_correct` - правильный ли ответ (boolean)
- `response_time_ms` - время ответа в миллисекундах
- `word_level_at_time` - уровень слова на момент ответа
- `submitted_at` - время подачи ответа
- `question_word` - показанное слово в вопросе

**Назначение:**
- Отслеживание каждой индивидуальной подачи ответа
- Аналитика обучения пользователей
- Правильный расчет последовательных правильных ответов
- Правильный расчет "3 из последних 10 попыток" для деградации

### 2. Обновление Таблицы quiz_session_stats

**Добавить поля:**
- `consecutive_correct` - количество правильных ответов подряд
- `last_10_attempts` - JSON массив последних 10 результатов (true/false)

**Назначение:**
- Быстрый доступ к счетчикам без сканирования submission_log
- Кэширование для производительности

### 3. Исправление Логики Продвижения Уровней

**Текущая проблема:** Система считает общее количество правильных ответов вместо последовательных.

**Требуемые изменения:**
- При правильном ответе: увеличить consecutive_correct на 1
- При неправильном ответе: сбросить consecutive_correct в 0
- Продвижение уровня только при consecutive_correct >= 3
- Сброс consecutive_correct при изменении уровня

### 4. Исправление Логики Деградации

**Текущая проблема:** Система проверяет только последовательные ошибки.

**Требуемые изменения:**
- Отслеживать массив последних 10 попыток для каждого слова
- Подсчитывать количество false в этом массиве
- Деградация при >= 3 неправильных ответов из последних 10
- Обновлять массив при каждой попытке (сдвиг + добавление нового результата)

### 5. Константы Системы (Реализация)

**В коде определить:**
```
MAX_FOCUS_WORDS = 20
CORRECT_ANSWERS_TO_MASTER = 3
MISTAKES_IN_LAST_ATTEMPTS = 3
LAST_ATTEMPTS_COUNT = 10
MAX_LAST_ASKED_WORDS = 7
```

### 6. Улучшенная Аналитика

**Новые возможности с submission_log:**
- Анализ времени ответа пользователей
- Выявление сложных слов и паттернов ошибок
- Отслеживание прогресса во времени
- A/B тестирование алгоритмов обучения
- Персонализация скорости обучения

### 7. Обновление API Логики submit_answer

**Новый алгоритм:**

1. **Записать подачу в submission_log**
   - Сохранить полный контекст ответа
   - Записать время ответа

2. **Обновить агрегированную статистику**
   - Увеличить attempts, correct/incorrect
   - Обновить consecutive_correct (увеличить или сбросить)
   - Обновить last_10_attempts массив

3. **Проверить условия продвижения уровня**
   - Проверить consecutive_correct >= 3
   - Если да, продвинуть уровень и сбросить счетчики

4. **Проверить условия деградации**
   - Подсчитать ошибки в last_10_attempts
   - Если >= 3, понизить уровень

5. **Обновить состояние сессии**
   - Обновить last_asked_words массив
   - Пополнить LEVEL_1 при необходимости

### 8. Миграция Данных

**При обновлении системы:**
- Создать новую таблицу submission_log
- Добавить новые поля в quiz_session_stats
- Сбросить существующие счетчики (или попытаться восстановить из имеющихся данных)
- Обновить все активные сессии

### 9. Индексы для Производительности

**Для submission_log:**
- `idx_submission_session_translation` на (session_id, translation_id, submitted_at)
- `idx_submission_user_time` на (session_id, submitted_at) для аналитики
- `idx_submission_translation_direction` на (translation_id, direction, submitted_at)

### 10. Тестирование Новой Логики

**Критические сценарии:**
- Продвижение после точно 3 правильных подряд
- Деградация при 3 ошибках из 10 попыток
- Правильный сброс счетчиков
- Корректная работа при переключении направлений
- Производительность при больших объемах данных

### 11. Обратная Совместимость

**Учесть:**
- Существующие пользователи с текущим прогрессом
- Плавный переход на новую систему
- Возможность отката при проблемах
- Сохранение общей статистики пользователей

---

## ПРИОРИТЕТЫ РЕАЛИЗАЦИИ

1. **Высокий приоритет:**
   - Создание submission_log таблицы
   - Исправление логики consecutive_correct
   - Исправление логики деградации

2. **Средний приоритет:**
   - Улучшенная аналитика
   - Оптимизация производительности
   - Расширенное тестирование

3. **Низкий приоритет:**
   - Дополнительные аналитические возможности
   - A/B тестирование функций