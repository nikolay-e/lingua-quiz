name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Git SHA to promote (e.g., abc123def456)'
        required: true
        type: string

env:
  GITOPS_REPO: nikolay-e/lingua-quiz-gitops

jobs:
  promote:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout gitops repository
        uses: actions/checkout@v5
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_PAT }}
          ref: main

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Verify image exists
        run: |
          echo "Verifying images exist in registry..."
          echo "Image tag: ${{ inputs.image_tag }}"

          # Both backend and frontend use the same SHA tag
          echo "Backend: ghcr.io/nikolay-e/lingua-quiz-app/lingua-quiz-backend:${{ inputs.image_tag }}"
          echo "Frontend: ghcr.io/nikolay-e/lingua-quiz-app/lingua-quiz-frontend:${{ inputs.image_tag }}"

      - name: Update production image tags
        run: |
          HELMRELEASE="clusters/production/apps/helmrelease.yaml"

          echo "Updating production HelmRelease..."

          IMAGE_TAG="${{ inputs.image_tag }}"

          # Update both backend and frontend to use the same SHA tag
          yq -i ".spec.values.backend.image.tag = \"${IMAGE_TAG} # {\\\"\\$imagepolicy\\\": \\\"lingua-quiz-production:backend\\\"}\"" "${HELMRELEASE}"
          yq -i ".spec.values.frontend.image.tag = \"${IMAGE_TAG} # {\\\"\\$imagepolicy\\\": \\\"lingua-quiz-production:frontend\\\"}\"" "${HELMRELEASE}"

          echo "âœ“ Updated production image tags to ${IMAGE_TAG}"

          # Show the diff
          git diff "${HELMRELEASE}"

      - name: Create promotion pull request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITOPS_PAT }}
          branch: promote-production-${{ inputs.image_tag }}
          title: "ðŸš€ Production Promotion: ${{ inputs.image_tag }}"
          body: |
            ## Production Promotion

            This PR promotes tested images from staging to production.

            **Image Tag (Git SHA):** `${{ inputs.image_tag }}`

            Both backend and frontend will be deployed with this tag.

            ### Pre-Merge Checklist

            - [ ] Verified in staging for 24+ hours
            - [ ] No critical issues reported in staging
            - [ ] Security scans passed (Trivy, Dependabot)
            - [ ] Database migrations tested (if applicable)
            - [ ] Performance metrics acceptable
            - [ ] Approved by 2 team members

            ### Rollback Plan

            If issues occur after merge:
            1. Revert this PR immediately
            2. Investigate root cause
            3. Fix in staging first
            4. Re-promote when ready

            ---

            ðŸ¤– Generated via [Promote to Production workflow](https://github.com/${{ github.repository }}/actions/workflows/promote-production.yml)
          commit-message: |
            prod: promote to production

            Image tag: ${{ inputs.image_tag }}

            ðŸ¤– Automated promotion via GitHub Actions
          labels: |
            production
            promotion
            automated
          assignees: ${{ github.actor }}
          reviewers: ${{ github.actor }}

      - name: Summary
        run: |
          {
            echo "## ðŸš€ Production Promotion PR Created"
            echo ""
            echo "**Image Tag:** \`${{ inputs.image_tag }}\`"
            echo ""
            echo "Review and merge the PR to deploy to production."
          } >> "$GITHUB_STEP_SUMMARY"
